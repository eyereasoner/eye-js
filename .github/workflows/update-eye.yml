name: Update to use the latest version of eye
on:
  schedule:
    - cron:  '0 */2 * * *'
jobs:
  get-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Commit latest release version
        run: |
          npm ci

          # Get version of EYE before any updates are run
          before=$(cat ./package.json | jq .config.eye.name)
          
          npm run eye:update

          # Version of EYE after getting updates
          current=$(cat ./package.json | jq .config.eye.name)

          readarray -d . -t before <<<"${before:2:-1}"
          readarray -d . -t after <<<"${current:2:-1}"

          if   [ ! ${before[0]} == ${after[0]} ]; then
            version="BREAKING CHANGE"
            branchHead="breaking"
          elif [ ! ${before[1]} == ${after[1]} ]; then
            version="feat"
            branchHead="feat"
          elif [ ! ${before[2]} == ${after[2]} ]; then
            version="fix"
            branchHead="fix"
          fi

          # The name of the new branch if we need to create one
          branch=$branchHead/update-eye-${current:1:-1}

          # Create a message that conforms to semantic release
          # note that we repeat this in the message body as semantic
          # release requires breaking changes to include BREAKING CHANGE
          # in the text body as well
          msg="$version: update to eye ${current:1:-1}
          
          $version: update to eye ${current:1:-1}
          "

          if [ $branchHead ]; then
            git checkout -b $branch
            git commit -am "$msg"
            git push --set-upstream origin $branch
            # FIXME: Check this with a dry run
            gh pr create -t "$msg" -b "$msg"
            gh pr merge $branch --auto --squash
          fi
